<%- include('partials/head', { title: `${obra.title} — Capítulo ${cap.number || cap.id}` }) %>

  <main class="container-fluid py-4 reader-page">
    <div class="reader-layout d-flex">
      <!-- Sidebar toggle button (visible when sidebar is collapsed) -->
      <button class="reader-sidebar-toggle" id="sidebarToggle" title="Abrir/fechar painel (S)">
        <i class="bi bi-layout-sidebar-inset"></i>
      </button>

      <!-- left: configurações (fixa) -->
      <aside class="reader-config" id="readerSidebar">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <a class="btn btn-sm btn-outline-light" href="/obra/<%= obra.id %>"><i class="bi bi-arrow-left me-1"></i>Voltar</a>
          <button class="btn btn-sm btn-outline-light" id="sidebarCollapseBtn" title="Recolher painel (S)">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <div class="mb-3">
          <h1 class="h6 text-light mb-1" style="line-height:1.3"><%= obra.title %></h1>
          <div style="font-size:0.78rem; color:rgba(255,255,255,0.5)">Capítulo <%= cap.number || cap.id %></div>
        </div>

        <!-- Chapter navigation -->
        <div class="d-flex gap-2 mb-3">
          <% if (typeof prevCap !== 'undefined' && prevCap) { %>
            <a class="btn btn-sm btn-outline-light flex-grow-1" href="/obra/<%= obra.id %>/cap/<%= prevCap.id %>/reader" title="Capítulo anterior (←)">
              <i class="bi bi-chevron-left me-1"></i>Cap. <%= prevCap.number || prevCap.id %>
            </a>
          <% } else { %>
            <button class="btn btn-sm btn-outline-secondary flex-grow-1" disabled>
              <i class="bi bi-chevron-left me-1"></i>Início
            </button>
          <% } %>
          <% if (typeof nextCap !== 'undefined' && nextCap) { %>
            <a class="btn btn-sm btn-outline-light flex-grow-1" href="/obra/<%= obra.id %>/cap/<%= nextCap.id %>/reader" title="Próximo capítulo (→)">
              Cap. <%= nextCap.number || nextCap.id %><i class="bi bi-chevron-right ms-1"></i>
            </a>
          <% } else { %>
            <button class="btn btn-sm btn-outline-secondary flex-grow-1" disabled>
              Fim<i class="bi bi-chevron-right ms-1"></i>
            </button>
          <% } %>
        </div>

        <hr class="border-secondary my-2">

        <h2 class="h6 text-light mb-2" style="font-size:0.82rem"><i class="bi bi-gear me-1"></i>Configurações</h2>

        <div class="mb-2">
          <label class="form-label small text-light">Largura (<span id="widthValue">50</span>%)</label>
          <input id="reader-width" type="range" min="30" max="100" value="50" class="form-range">
        </div>

        <hr class="border-secondary my-2">

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="toggle-overlays" checked>
          <label class="form-check-label small text-light" for="toggle-overlays">Mostrar traduções</label>
        </div>

        <div class="mb-2">
          <label class="form-label small text-light">Opacidade do box</label>
          <input id="overlay-opacity" type="range" min="0" max="100" value="100" class="form-range">
        </div>

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="center-horizontal" checked>
          <label class="form-check-label small text-light" for="center-horizontal">Centralizar horizontal</label>
        </div>
        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="center-vertical" checked>
          <label class="form-check-label small text-light" for="center-vertical">Centralizar vertical</label>
        </div>

        <hr class="border-secondary my-2">

        <div class="mb-2">
          <label class="form-label small text-light">Cor de fundo dos boxes</label>
          <input id="box-bg-color" type="color" value="#ffffff" class="form-control form-control-color form-control-sm">
        </div>
        <div class="mb-2">
          <label class="form-label small text-light">Cor do texto</label>
          <input id="text-color" type="color" value="#111111" class="form-control form-control-color form-control-sm">
        </div>
        <div class="mb-2">
          <label class="form-label small text-light">Fundo do texto</label>
          <input id="text-bg-color" type="color" value="#ffffff" class="form-control form-control-color form-control-sm">
        </div>

        <hr class="border-secondary my-2">

        <button class="btn btn-sm btn-outline-light w-100 mb-2" id="fullscreenBtn" title="Tela cheia (F)">
          <i class="bi bi-arrows-fullscreen me-1"></i>Tela cheia
        </button>

        <button class="btn btn-sm btn-outline-secondary w-100" id="showKbdHelp" title="Atalhos de teclado (?)">
          <i class="bi bi-keyboard me-1"></i>Atalhos
        </button>
      </aside>

      <!-- Image progress indicator -->
      <div class="reader-progress-indicator" id="readerProgressIndicator">
        <span id="readerProgressText">0 / 0</span>
      </div>

      <!-- right: leitura (rolável) -->
      <section id="reader" class="reader reader-content flex-grow-1" data-obra-id="<%= obra.id %>" data-cap-id="<%= cap.id %>"
        <% if (typeof prevCap !== 'undefined' && prevCap) { %>data-prev-cap-url="/obra/<%= obra.id %>/cap/<%= prevCap.id %>/reader"<% } %>
        <% if (typeof nextCap !== 'undefined' && nextCap) { %>data-next-cap-url="/obra/<%= obra.id %>/cap/<%= nextCap.id %>/reader"<% } %>
      >
        <% if (imagens && imagens.length) { %>
          <% imagens.forEach(function(img, imgIdx){ %>
            <div class="reader-image-wrap my-3 d-flex justify-content-center position-relative" data-img-index="<%= imgIdx + 1 %>">
              <img data-img-id="<%= img.id %>" class="reader-img" src="/obras/<%= obra.id %>/capitulos/<%= cap.id %>/imagens/<%= img.id %>/file" alt="img-<%= img.id %>" loading="lazy" />
              <div class="reader-overlay" style="position:absolute;left:0;top:0;width:100%;height:100%;"></div>
            </div>
          <% }); %>

          <!-- Bottom chapter navigation -->
          <div class="reader-bottom-nav d-flex justify-content-center gap-3 my-4">
            <% if (typeof prevCap !== 'undefined' && prevCap) { %>
              <a class="btn btn-outline-light" href="/obra/<%= obra.id %>/cap/<%= prevCap.id %>/reader">
                <i class="bi bi-chevron-left me-1"></i>Capítulo anterior
              </a>
            <% } %>
            <a class="btn btn-outline-light" href="/obra/<%= obra.id %>">
              <i class="bi bi-list-ul me-1"></i>Lista de capítulos
            </a>
            <% if (typeof nextCap !== 'undefined' && nextCap) { %>
              <a class="btn btn-outline-light" href="/obra/<%= obra.id %>/cap/<%= nextCap.id %>/reader">
                Próximo capítulo<i class="bi bi-chevron-right ms-1"></i>
              </a>
            <% } %>
          </div>
        <% } else { %>
          <div class="empty-state" style="color:#aaa">
            <div class="empty-icon"><i class="bi bi-image"></i></div>
            <div class="empty-title">Nenhuma imagem disponível</div>
            <div class="empty-desc">Este capítulo não possui imagens para leitura.</div>
          </div>
        <% } %>
      </section>
    </div>
  </main>

  <!-- Keyboard help overlay -->
  <div class="kbd-help" id="kbdHelp">
    <strong style="color:var(--text-primary)">Atalhos de teclado</strong><br>
    <kbd>←</kbd> Capítulo anterior<br>
    <kbd>→</kbd> Próximo capítulo<br>
    <kbd>T</kbd> Mostrar/ocultar traduções<br>
    <kbd>S</kbd> Abrir/fechar painel<br>
    <kbd>F</kbd> Tela cheia<br>
    <kbd>Home</kbd> Voltar ao topo<br>
    <kbd>?</kbd> Mostrar/ocultar atalhos<br>
    <kbd>Esc</kbd> Fechar painel/atalhos
  </div>

  <style>
  html, body { height: 100%; }
  body.reader-dark { background: #0f1113; color: #eee; margin: 0; padding: 20px; }
  .reader-page { background: transparent; color: #eee; min-height: 100vh; max-width: none; margin: 0; padding: 0; }
  /* hide the global navbar on reader page */
  .reader-page ~ .leitor-nav, body.reader-dark .leitor-nav { display: none; }
  .leitor-nav { display: none; }
  .reader-layout { gap: 1rem; display: flex; width: 100%; }
  .reader-config {
    width: 300px; flex: 0 0 300px; height: calc(100vh - 40px); overflow: auto;
    border-radius: 10px; position: fixed; top: 20px; left: 20px; z-index: 999;
    background: rgba(15,17,19,0.95); backdrop-filter: blur(16px); padding: 20px;
    border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    transition: transform 0.3s ease, opacity 0.3s ease;
    color: #eee;
  }
  .reader-config.collapsed { transform: translateX(-340px); opacity: 0; pointer-events: none; }
  .reader-content { padding-right: 8px; flex: 1 1 auto; margin-left: 340px; transition: margin-left 0.3s ease; }
  .reader-content.expanded { margin-left: 20px; }

  .reader-sidebar-toggle {
    position: fixed; top: 20px; left: 20px; z-index: 998;
    width: 42px; height: 42px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);
    background: rgba(15,17,19,0.9); backdrop-filter: blur(12px); color: #eee;
    display: none; align-items: center; justify-content: center; font-size: 18px;
    cursor: pointer; transition: all 0.2s ease;
  }
  .reader-sidebar-toggle:hover { background: rgba(255,255,255,0.1); }
  .reader-sidebar-toggle.visible { display: flex; }

  .reader-progress-indicator {
    position: fixed; top: 20px; right: 20px; z-index: 998;
    background: rgba(15,17,19,0.85); backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.08); border-radius: 8px;
    padding: 6px 14px; font-size: 0.78rem; color: rgba(255,255,255,0.6);
    font-family: var(--font-mono); pointer-events: none;
  }

  .reader-bottom-nav { padding-bottom: 40px; }

  @media (max-width: 900px) {
    .reader-config { position: static; width: 100%; height: auto; left: auto; top: auto; z-index: auto; transform: none !important; opacity: 1 !important; pointer-events: auto !important; }
    .reader-config.collapsed { display: none; }
    .reader-content { margin-left: 0 !important; }
    body.reader-dark { padding: 12px; }
    .reader-sidebar-toggle { display: flex; top: 12px; left: 12px; }
    .reader-sidebar-toggle.visible { display: flex; }
    .reader-progress-indicator { top: 12px; right: 12px; }
  }
  .reader-img { transition: width 0.15s ease; max-width: 100%; height: auto; background: #111; display: block; }
  .reader-image-wrap { overflow: hidden; }
  .ex-overlay {
    box-sizing: border-box; color: #111; font-weight: 600;
    background: rgba(255,255,0,0.6); padding: 4px 6px; border-radius: 6px;
    transition: transform 0.12s ease, font-size 0.12s ease, opacity 0.12s ease;
    display: inline-flex; align-items: flex-start; justify-content: flex-start;
    line-height: 1.05; word-break: break-word; text-align: left;
  }
  .ex-overlay .ex-text { display: inline-block; padding: 0 2px; }
  .ex-popover {
    background: rgba(14,14,16,0.95); color: #fff; padding: 10px 14px;
    border-radius: 8px; box-shadow: 0 12px 32px rgba(0,0,0,0.6);
    max-width: 80vw; font-size: clamp(16px, 2.4vw, 28px); line-height: 1.25;
    white-space: pre-wrap; word-break: break-word; opacity: 0;
    transition: opacity 120ms ease; pointer-events: none;
  }
  .ex-overlay::selection { background: rgba(0,0,0,0.12); }

  /* Scroll to top for reader */
  body.reader-dark .scroll-top-btn { display: none; }
  body.reader-dark .leitor-footer { display: none; }
  body.reader-dark .toast-container { top: 12px; }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      document.body.classList.add('reader-dark');
      // hide navbar in reader
      var nav = document.querySelector('.leitor-nav');
      if (nav) nav.style.display = 'none';
    });
  </script>
  <script src="/js/reader.js"></script>
  <%- include('partials/scripts') %>
